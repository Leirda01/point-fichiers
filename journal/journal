#!/usr/bin/env bash

[[ $(type -t $1) ]] && call_command="$1" && shift
[[ $HOME/.config/journal/"$1" ]] && call_command=$HOME/.config/journal/"$1" && shift
[[ $(vim --version | grep +clientserver) ]] && socket=true

[[ $(date +%-H) -lt 4 ]] && date="yesterday" || date="today"
date=$(date --date=$date +%Y/%m/%d)

[[ $@ ]] && journal="${@%%.adoc}.adoc" || journal="main.adoc"
path="$HOME/saveuriendir/$date/"

mkdir -p "$path"; cd "$path"
if [[ $call_command ]]; then
  $call_command "$@"
else
  if [[ $($socket && vim --serverlist | grep JOURNAL) ]]; then
    vim --servername JOURNAL --remote-send "<C-\><C-N>:xall<CR>:qall!<CR>"
  fi

  vim $([[ $socket ]] && echo --servername JOURNAL) "$journal"
fi
