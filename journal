#!/usr/bin/env bash

[[ $(type -p $1) ]] && call_command=true
[[ $(vim --version | grep +clientserver) ]] && vim_in_socket=true

[[ $(date +%-H) -lt 4 ]] && date="yesterday" || date="today"
date=$(date --date=$date +%Y/%m/%d)

[[ $call_command ]] && args="${@:2}" || args="${@}"

journal="${args:-main}"
path="$HOME/saveuriendir/$date/${journal%%.md}.md"

if [[ $call_command ]]; then
  $1 "$path"
else
  if [[ $vim_in_socket ]]; then
    if [[ $(vim --serverlist | grep JOURNAL) ]]; then
      vim --servername JOURNAL --remote-send "<C-\><C-N>:xall:qall!"
    fi
  fi

  mkdir -p "$HOME/saveuriendir/$date"
  if [[ $vim_in_socket ]]; then
    vim --servername JOURNAL "$path"
  else
    vim "$path"
  fi
fi
